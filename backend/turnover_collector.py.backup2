#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å‘¨è½‰ç‡æ•¸æ“šæ”¶é›†å™¨ v2.1
1. æŠ“å–å…¨éƒ¨è‚¡ç¥¨è¨ˆç®—å‘¨è½‰ç‡ TOP N
2. è¨ˆç®—çˆ†é‡å€æ•¸ (vs è¿‘5æ—¥å‡é‡)
3. æ–°å¢è‚¡åƒ¹ã€æ¼²è·Œ%
"""

import requests
import sqlite3
from datetime import datetime, timedelta

# TWSE ç”¢æ¥­ä»£ç¢¼å°ç…§è¡¨
INDUSTRY_CODE_MAP = {
    '01': 'æ°´æ³¥', '02': 'é£Ÿå“', '03': 'å¡‘è† ', '04': 'ç´¡ç¹”',
    '05': 'é›»æ©Ÿ', '06': 'é›»å™¨é›»çºœ', '08': 'ç»ç’ƒé™¶ç“·', '09': 'é€ ç´™',
    '10': 'é‹¼éµ', '11': 'æ©¡è† ', '12': 'æ±½è»Š', '14': 'å»ºæç‡Ÿé€ ',
    '15': 'èˆªé‹', '16': 'è§€å…‰', '17': 'é‡‘è', '18': 'è²¿æ˜“ç™¾è²¨',
    '20': 'å…¶ä»–', '21': 'åŒ–å·¥', '22': 'ç”ŸæŠ€é†«ç™‚', '23': 'æ²¹é›»ç‡ƒæ°£',
    '24': 'åŠå°é«”', '25': 'é›»è…¦é€±é‚Š', '26': 'å…‰é›»', '27': 'é€šè¨Šç¶²è·¯',
    '28': 'é›»å­é›¶çµ„ä»¶', '29': 'é›»å­é€šè·¯', '30': 'è³‡è¨Šæœå‹™', '31': 'å…¶ä»–é›»å­',
    '35': 'ç¶ èƒ½ç’°ä¿', '36': 'æ•¸ä½é›²ç«¯', '37': 'é‹å‹•ä¼‘é–’', '38': 'å±…å®¶ç”Ÿæ´»',
    '91': 'DR'
}

def get_industry_name(code):
    """å°‡ç”¢æ¥­ä»£ç¢¼è½‰æ›ç‚ºåç¨±"""
    return INDUSTRY_CODE_MAP.get(code, 'å…¶ä»–')


def get_all_stocks_volume():
    """å–å¾—æ‰€æœ‰è‚¡ç¥¨ç•¶æ—¥æˆäº¤é‡ã€è‚¡åƒ¹ã€æ¼²è·Œ% (å‰”é™¤ ETF)"""
    try:
        url = "https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&type=ALL"
        r = requests.get(url, headers={'User-Agent': 'Mozilla/5.0'}, timeout=15)
        data = r.json()
        
        table8 = data['tables'][8]
        stocks = {}
        
        for stock in table8['data']:
            code = stock[0]
            name = stock[1]
            volume_str = stock[2].replace(',', '')
            
            if volume_str and volume_str.isdigit():
                # å‰”é™¤ ETF/ETN
                is_etf = (
                    code.startswith('00') or 
                    'ETF' in name or 
                    'etf' in name or
                    'ETN' in name
                )
                
                if not is_etf:
                    # è§£æè‚¡åƒ¹å’Œæ¼²è·Œ
                    close_price = None
                    change_pct = None
                    
                    try:
                        # æ”¶ç›¤åƒ¹ [8]
                        close_str = stock[8].replace(',', '')
                        if close_str and close_str != '--':
                            close_price = float(close_str)
                        
                        # æ¼²è·Œæ–¹å‘ [9] - è§£æ HTML
                        change_dir = stock[9]
                        is_down = 'green' in change_dir or '-' in change_dir
                        
                        # æ¼²è·Œåƒ¹å·® [10]
                        change_str = stock[10].replace(',', '')
                        if close_price and change_str and change_str != '--':
                            change_val = float(change_str)
                            if is_down:
                                change_val = -change_val
                            # è¨ˆç®—æ¼²è·Œ%
                            prev_price = close_price - change_val
                            if prev_price > 0:
                                change_pct = round((change_val / prev_price) * 100, 2)
                    except:
                        pass
                    
                    stocks[code] = {
                        'code': code,
                        'name': name,
                        'volume': int(volume_str),
                        'close_price': close_price,
                        'change_pct': change_pct
                    }
        
        return stocks
    
    except Exception as e:
        print(f"âœ— æŠ“å–æˆäº¤é‡å¤±æ•—: {e}")
        return {}

def get_issued_shares():
    """å–å¾—æ‰€æœ‰ä¸Šå¸‚å…¬å¸ç™¼è¡Œè‚¡æ•¸å’Œç”¢æ¥­"""
    try:
        url = "https://openapi.twse.com.tw/v1/opendata/t187ap03_L"
        r = requests.get(url, headers={'User-Agent': 'Mozilla/5.0'}, timeout=10)
        data = r.json()
        
        shares_dict = {}
        industry_dict = {}
        for item in data:
            code = item.get('å…¬å¸ä»£è™Ÿ', '')
            shares = item.get('å·²ç™¼è¡Œæ™®é€šè‚¡æ•¸æˆ–TDRåŸè‚¡ç™¼è¡Œè‚¡æ•¸', '0')
            industry_code = item.get('ç”¢æ¥­åˆ¥', '')
            if code and shares:
                shares_dict[code] = int(shares)
                industry_dict[code] = get_industry_name(industry_code)
        
        return shares_dict, industry_dict
    
    except Exception as e:
        print(f"âœ— æŠ“å–ç™¼è¡Œè‚¡æ•¸å¤±æ•—: {e}")
        return {}, {}

def get_avg_volume(cursor, code, days=5):
    """å–å¾—è¿‘Næ—¥å¹³å‡æˆäº¤é‡"""
    cursor.execute('''
        SELECT AVG(volume) FROM (
            SELECT volume FROM turnover_history 
            WHERE stock_code = ? 
            ORDER BY date DESC 
            LIMIT ?
        )
    ''', (code, days))
    result = cursor.fetchone()
    return result[0] if result and result[0] else None
def get_industry_from_db(cursor, code):
    """å¾è³‡æ–™åº«å–å¾—ç”¢æ¥­åˆ†é¡"""
    cursor.execute('SELECT industry FROM turnover_history WHERE stock_code = ? LIMIT 1', (code,))
    result = cursor.fetchone()
    return result[0] if result else 'å…¶ä»–'

def calculate_turnover_and_surge(stocks_volume, shares_dict, industry_dict, cursor):
    """è¨ˆç®—å‘¨è½‰ç‡å’Œçˆ†é‡å€æ•¸"""
    results = []
    
    for code, stock in stocks_volume.items():
        issued_shares = shares_dict.get(code, 0)
        if issued_shares <= 0:
            continue
        
        volume = stock['volume']
        turnover_rate = (volume / issued_shares) * 100
        
        # è¨ˆç®—çˆ†é‡å€æ•¸
        avg_volume = get_avg_volume(cursor, code, 5)
        surge_ratio = (volume / avg_volume) if avg_volume and avg_volume > 0 else None
        
        # å–å¾—ç”¢æ¥­ (å„ªå…ˆç”¨ APIï¼Œå…¶æ¬¡ç”¨ DB)
        industry = industry_dict.get(code) or get_industry_from_db(cursor, code) or 'å…¶ä»–'
        
        results.append({
            'code': code,
            'name': stock['name'],
            'industry': industry,
            'volume': volume,
            'issued_shares': issued_shares,
            'turnover_rate': turnover_rate,
            'surge_ratio': surge_ratio,
            'close_price': stock.get('close_price'),
            'change_pct': stock.get('change_pct')
        })
    
    return results

def save_to_database(date, stocks_data):
    """å„²å­˜å‘¨è½‰ç‡è³‡æ–™åˆ°è³‡æ–™åº«"""
    conn = sqlite3.connect('market_data.db')
    cursor = conn.cursor()
    
    # ç¢ºä¿è¡¨æ ¼æœ‰æ–°æ¬„ä½
    for col in ['surge_ratio REAL', 'close_price REAL', 'change_pct REAL']:
        try:
            cursor.execute(f'ALTER TABLE turnover_history ADD COLUMN {col}')
        except:
            pass  # æ¬„ä½å·²å­˜åœ¨
    
    saved_count = 0
    
    for stock in stocks_data:
        try:
            cursor.execute('''
                INSERT OR REPLACE INTO turnover_history 
                (date, stock_code, stock_name, industry, volume, issued_shares, turnover_rate, surge_ratio, close_price, change_pct)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (date, stock['code'], stock['name'], stock['industry'], 
                  stock['volume'], stock['issued_shares'], stock['turnover_rate'], 
                  stock['surge_ratio'], stock['close_price'], stock['change_pct']))
            saved_count += 1
        except Exception as e:
            print(f"âœ— å„²å­˜ {stock['code']} å¤±æ•—: {e}")
    
    conn.commit()
    conn.close()
    
    return saved_count

def clean_old_data(days=30):
    """æ¸…ç†è¶…éNå¤©çš„èˆŠè³‡æ–™"""
    conn = sqlite3.connect('market_data.db')
    cursor = conn.cursor()
    
    cutoff_date = (datetime.now() - timedelta(days=days)).strftime('%Y%m%d')
    cursor.execute('DELETE FROM turnover_history WHERE date < ?', (cutoff_date,))
    deleted_count = cursor.rowcount
    
    conn.commit()
    conn.close()
    
    return deleted_count

def collect_turnover_data():
    """ä¸»å‡½æ•¸:æ”¶é›†å‘¨è½‰ç‡è³‡æ–™"""
    print("="*60)
    print("ğŸ“Š å‘¨è½‰ç‡æ•¸æ“šæ”¶é›† v2.1 (å«è‚¡åƒ¹/æ¼²è·Œ%)")
    print("="*60)
    
    today = datetime.now().strftime('%Y%m%d')
    print(f"æ—¥æœŸ: {today}\n")
    
    # Step 1: æŠ“å–å…¨éƒ¨è‚¡ç¥¨æˆäº¤é‡
    print("[1/5] æŠ“å–å…¨éƒ¨è‚¡ç¥¨æˆäº¤é‡ã€è‚¡åƒ¹ã€æ¼²è·Œ%...")
    stocks_volume = get_all_stocks_volume()
    
    if not stocks_volume:
        print("âœ— ç„¡æ³•å–å¾—æˆäº¤é‡è³‡æ–™")
        return False
    
    print(f"âœ“ å·²å–å¾— {len(stocks_volume)} æª”è‚¡ç¥¨")
    
    # Step 2: æŠ“å–ç™¼è¡Œè‚¡æ•¸
    print("\n[2/5] æŠ“å–ç™¼è¡Œè‚¡æ•¸...")
    shares_dict, industry_dict = get_issued_shares()
    
    if not shares_dict:
        print("âœ— ç„¡æ³•å–å¾—ç™¼è¡Œè‚¡æ•¸")
        return False
    
    print(f"âœ“ å·²å–å¾— {len(shares_dict)} æª”è‚¡ç¥¨ç™¼è¡Œè‚¡æ•¸")
    
    # Step 3: è¨ˆç®—å‘¨è½‰ç‡å’Œçˆ†é‡å€æ•¸
    print("\n[3/5] è¨ˆç®—å‘¨è½‰ç‡å’Œçˆ†é‡å€æ•¸...")
    conn = sqlite3.connect('market_data.db')
    cursor = conn.cursor()
    stocks_data = calculate_turnover_and_surge(stocks_volume, shares_dict, industry_dict, cursor)
    conn.close()
    
    # ç¯©é¸: å‘¨è½‰ç‡ >= 5% æˆ– çˆ†é‡ >= 2å€
    filtered = [s for s in stocks_data if s['turnover_rate'] >= 5 or (s['surge_ratio'] and s['surge_ratio'] >= 2)]
    
    # æ’åº: å‘¨è½‰ç‡å„ªå…ˆ
    filtered.sort(key=lambda x: x['turnover_rate'], reverse=True)
    
    # å– TOP 50
    top_stocks = filtered[:50]
    
    print(f"âœ“ ç¯©é¸å‡º {len(top_stocks)} æª” (å‘¨è½‰ç‡>=5% æˆ– çˆ†é‡>=2å€)")
    
    # Step 4: å„²å­˜åˆ°è³‡æ–™åº«
    print("\n[4/5] å„²å­˜åˆ°è³‡æ–™åº«...")
    saved_count = save_to_database(today, top_stocks)
    print(f"âœ“ å·²å„²å­˜ {saved_count} ç­†è³‡æ–™")
    
    # Step 5: æ¸…ç†èˆŠè³‡æ–™
    print("\n[5/5] æ¸…ç†èˆŠè³‡æ–™ (ä¿ç•™30å¤©)...")
    deleted_count = clean_old_data(30)
    print(f"âœ“ å·²åˆªé™¤ {deleted_count} ç­†èˆŠè³‡æ–™")
    
    # é¡¯ç¤ºæ‘˜è¦
    print("\n" + "-"*60)
    print("ğŸ“‹ ä»Šæ—¥æ‘˜è¦:")
    overheat = [s for s in top_stocks if s['turnover_rate'] >= 15]
    surge = [s for s in top_stocks if s['surge_ratio'] and s['surge_ratio'] >= 3]
    both = [s for s in top_stocks if s['turnover_rate'] >= 15 and s['surge_ratio'] and s['surge_ratio'] >= 3]
    
    print(f"   é«˜å‘¨è½‰ (>=15%): {len(overheat)} æª”")
    print(f"   çˆ†é‡ (>=3å€): {len(surge)} æª”")
    print(f"   å…©è€…çš†æ˜¯: {len(both)} æª”")
    
    print("\n" + "="*60)
    print("âœ“ å‘¨è½‰ç‡æ•¸æ“šæ”¶é›†å®Œæˆ!")
    print("="*60)
    
    return True

if __name__ == '__main__':
    collect_turnover_data()
