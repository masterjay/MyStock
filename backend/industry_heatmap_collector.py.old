#!/usr/bin/env python3
import json
from collections import defaultdict
from datetime import datetime

def collect_industry_heatmap():
    """收集產業漲跌幅數據,用於產業熱圖"""
    
    # 從周轉率數據中提取
    with open('data/turnover_analysis.json', 'r') as f:
        turnover_data = json.load(f)
    
    # 統計各產業
    industry_data = defaultdict(lambda: {'stocks': [], 'total_change': 0, 'count': 0})
    
    for stock in turnover_data.get('all_stocks', []):
        industry = stock.get('industry', '其他')
        change_pct = stock.get('change_pct', 0)
        
        industry_data[industry]['stocks'].append({
            'code': stock['code'],
            'name': stock['name'],
            'change_pct': change_pct
        })
        industry_data[industry]['total_change'] += change_pct
        industry_data[industry]['count'] += 1
    
    # 計算平均漲跌幅和上漲比例
    result = []
    for industry, data in industry_data.items():
        avg_change = data['total_change'] / data['count'] if data['count'] > 0 else 0
        up_count = sum(1 for s in data['stocks'] if s['change_pct'] > 0)
        up_ratio = (up_count / data['count'] * 100) if data['count'] > 0 else 0
        
        result.append({
            'industry': industry,
            'avg_change': round(avg_change, 2),
            'up_ratio': round(up_ratio, 1),
            'stock_count': data['count'],
            'up_count': up_count,
            'down_count': data['count'] - up_count
        })
    
    # 按平均漲跌幅排序
    result.sort(key=lambda x: x['avg_change'], reverse=True)
    
    # 保存
    output = {
        'date': datetime.now().strftime('%Y%m%d'),
        'updated_at': datetime.now().isoformat(),
        'industries': result
    }
    
    with open('data/industry_heatmap.json', 'w', encoding='utf-8') as f:
        json.dump(output, f, ensure_ascii=False, indent=2)
    
    print(f"✓ 產業熱圖數據已更新: {len(result)} 個產業")
    return output

if __name__ == '__main__':
    collect_industry_heatmap()
