#!/usr/bin/env python3
"""
每日自動執行腳本
由 launchd 定時呼叫
"""
import sys
import os
from datetime import datetime
from pathlib import Path

# 確保在正確的目錄
script_dir = Path(__file__).parent
os.chdir(script_dir)

# 建立 logs 目錄
Path('logs').mkdir(exist_ok=True)

print(f"\n{'='*60}")
print(f"台股監控 - 每日自動執行")
print(f"執行時間: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
print(f"{'='*60}\n")

try:
    # 1. 導入資料收集器
    from data_collector import DataCollector
    
    # 執行資料收集
    collector = DataCollector()
    
    print("開始收集當日數據...")
    result = collector.collect_daily_data()
    
    if result:
        print("✓ 數據收集成功")
        
        # 導出 JSON
        print("導出數據到 JSON...")
        collector.export_to_json()
        print("✓ 完成!")
    else:
        print("✗ 數據收集失敗")
        sys.exit(1)
    
    # 2. 收集漲停跌停股
    print("\n[額外收集] 漲停跌停股...")
    try:
        from limit_updown_collector import collect_limit_updown
        collect_limit_updown()
        print("✓ 漲停跌停股收集完成")
    except Exception as e:
        print(f"✗ 漲停跌停股收集失敗: {e}")
    
    # 3. 收集產業外資流向
    print("\n[額外收集] 產業外資流向...")
    try:
        from industry_foreign_flow_collector import collect_industry_foreign_flow
        collect_industry_foreign_flow()
        print("✓ 產業外資流向收集完成")
    except Exception as e:
        print(f"✗ 產業外資流向收集失敗: {e}")
        
except Exception as e:
    print(f"✗ 執行錯誤: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

print(f"\n{'='*60}")
print(f"執行完成: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
print(f"{'='*60}\n")
