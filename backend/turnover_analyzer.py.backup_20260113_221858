#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å‘¨è½‰ç‡åˆ†æå™¨
åˆ†æé€£çºŒéç†±å¤©æ•¸ã€ç”¢æ¥­è¼ªå‹•ç­‰
"""

import sqlite3
import json
from datetime import datetime, timedelta
from collections import Counter

def get_consecutive_overheat_days(stock_code, days=7):
    """è¨ˆç®—é€£çºŒéç†±å¤©æ•¸"""
    conn = sqlite3.connect('market_data.db')
    cursor = conn.cursor()
    
    # å–å¾—æœ€è¿‘Nå¤©çš„å‘¨è½‰ç‡
    cursor.execute('''
        SELECT date, turnover_rate 
        FROM turnover_history 
        WHERE stock_code = ?
        ORDER BY date DESC
        LIMIT ?
    ''', (stock_code, days))
    
    records = cursor.fetchall()
    conn.close()
    
    if not records:
        return 0
    
    # è¨ˆç®—é€£çºŒå¤©æ•¸ (å¾æœ€è¿‘é–‹å§‹ç®—)
    consecutive = 0
    for date, rate in records:
        if rate >= 15:  # éç†±é–€æª»
            consecutive += 1
        else:
            break
    
    return consecutive

def get_overheat_stocks():
    """å–å¾—æ‰€æœ‰éç†±è‚¡ç¥¨åŠå…¶é€£çºŒå¤©æ•¸"""
    conn = sqlite3.connect('market_data.db')
    cursor = conn.cursor()
    
    # å–å¾—ä»Šæ—¥å‘¨è½‰ç‡ â‰¥15% çš„è‚¡ç¥¨
    today = datetime.now().strftime('%Y%m%d')
    
    cursor.execute('''
        SELECT stock_code, stock_name, industry, turnover_rate, volume
        FROM turnover_history 
        WHERE date = ? AND turnover_rate >= 15
        ORDER BY turnover_rate DESC
    ''', (today,))
    
    overheat_stocks = []
    
    for row in cursor.fetchall():
        code, name, industry, rate, volume = row
        
        # è¨ˆç®—é€£çºŒå¤©æ•¸
        consecutive_days = get_consecutive_overheat_days(code, 7)
        
        # å–å¾—7æ—¥æ­·å²
        cursor.execute('''
            SELECT date, turnover_rate 
            FROM turnover_history 
            WHERE stock_code = ?
            ORDER BY date DESC
            LIMIT 7
        ''', (code,))
        
        history = [{'date': r[0], 'rate': r[1]} for r in cursor.fetchall()]
        
        # åˆ¤æ–·å±éšªç­‰ç´š
        if consecutive_days >= 5:
            danger_level = 'æ¥µåº¦å±éšª'
            danger_icon = 'ğŸš¨ğŸš¨ğŸš¨'
        elif consecutive_days >= 4:
            danger_level = 'åš´é‡éç†±'
            danger_icon = 'ğŸ”´ğŸ”´'
        elif consecutive_days >= 3:
            danger_level = 'éç†±'
            danger_icon = 'ğŸ”´'
        elif consecutive_days >= 2:
            danger_level = 'è­¦æˆ’'
            danger_icon = 'ğŸŸ¡'
        else:
            danger_level = 'æ–°ä¸Šæ¦œ'
            danger_icon = 'ğŸ†•'
        
        overheat_stocks.append({
            'code': code,
            'name': name,
            'industry': industry,
            'turnover_rate': rate,
            'volume': volume,
            'consecutive_days': consecutive_days,
            'danger_level': danger_level,
            'danger_icon': danger_icon,
            'history': history
        })
    
    conn.close()
    return overheat_stocks

def get_industry_analysis():
    """ç”¢æ¥­è¼ªå‹•åˆ†æ"""
    conn = sqlite3.connect('market_data.db')
    cursor = conn.cursor()
    
    today = datetime.now().strftime('%Y%m%d')
    
    # å–å¾—ä»Šæ—¥éç†±è‚¡ç¥¨çš„ç”¢æ¥­åˆ†å¸ƒ
    cursor.execute('''
        SELECT industry, COUNT(*) as count
        FROM turnover_history 
        WHERE date = ? AND turnover_rate >= 15
        GROUP BY industry
        ORDER BY count DESC
    ''', (today,))
    
    industry_stats = []
    for industry, count in cursor.fetchall():
        industry_stats.append({
            'industry': industry,
            'count': count
        })
    
    conn.close()
    return industry_stats

def get_statistics():
    """å–å¾—æ•´é«”çµ±è¨ˆ"""
    conn = sqlite3.connect('market_data.db')
    cursor = conn.cursor()
    
    today = datetime.now().strftime('%Y%m%d')
    
    # çµ±è¨ˆå„ç­‰ç´šæ•¸é‡
    cursor.execute('''
        SELECT 
            COUNT(CASE WHEN turnover_rate >= 15 THEN 1 END) as overheat,
            COUNT(CASE WHEN turnover_rate >= 10 AND turnover_rate < 15 THEN 1 END) as warning,
            COUNT(CASE WHEN turnover_rate >= 5 AND turnover_rate < 10 THEN 1 END) as active,
            COUNT(CASE WHEN turnover_rate < 5 THEN 1 END) as normal
        FROM turnover_history 
        WHERE date = ?
    ''', (today,))
    
    row = cursor.fetchone()
    
    stats = {
        'overheat': row[0],
        'warning': row[1],
        'active': row[2],
        'normal': row[3]
    }
    
    conn.close()
    return stats

def get_all_stocks_classified():
    """å–å¾—æ‰€æœ‰è‚¡ç¥¨ä¸¦åˆ†é¡"""
    conn = sqlite3.connect('market_data.db')
    cursor = conn.cursor()
    
    today = datetime.now().strftime('%Y%m%d')
    
    cursor.execute('''
        SELECT stock_code, stock_name, industry, turnover_rate, volume
        FROM turnover_history 
        WHERE date = ?
        ORDER BY volume DESC
    ''', (today,))
    
    all_stocks = []
    active_stocks = []
    normal_stocks = []
    
    for row in cursor.fetchall():
        code, name, industry, rate, volume = row
        
        stock_data = {
            'code': code,
            'name': name,
            'industry': industry,
            'turnover_rate': rate,
            'volume': volume
        }
        
        all_stocks.append(stock_data)
        
        if rate < 15:
            if 5 <= rate < 10:
                active_stocks.append(stock_data)
            elif rate < 5:
                normal_stocks.append(stock_data)
    
    conn.close()
    
    return {
        'all': all_stocks,
        'active': active_stocks,
        'normal': normal_stocks
    }

def analyze_and_export():
    """åˆ†æä¸¦è¼¸å‡º JSON"""
    print("="*60)
    print("ğŸ“Š å‘¨è½‰ç‡åˆ†æ")
    print("="*60)
    
    # 1. å–å¾—éç†±è‚¡ç¥¨
    print("\n[1/3] åˆ†æéç†±è‚¡ç¥¨...")
    overheat_stocks = get_overheat_stocks()
    
    # æŒ‰å±éšªç­‰ç´šåˆ†é¡
    extreme_danger = [s for s in overheat_stocks if s['consecutive_days'] >= 5]
    severe = [s for s in overheat_stocks if s['consecutive_days'] == 4]
    overheat = [s for s in overheat_stocks if s['consecutive_days'] == 3]
    warning = [s for s in overheat_stocks if s['consecutive_days'] == 2]
    new = [s for s in overheat_stocks if s['consecutive_days'] == 1]
    
    print(f"  ğŸš¨ æ¥µåº¦å±éšª (â‰¥5å¤©): {len(extreme_danger)} æª”")
    print(f"  ğŸ”´ åš´é‡éç†± (4å¤©): {len(severe)} æª”")
    print(f"  ğŸ”´ éç†± (3å¤©): {len(overheat)} æª”")
    print(f"  ğŸŸ¡ è­¦æˆ’ (2å¤©): {len(warning)} æª”")
    print(f"  ğŸ†• æ–°ä¸Šæ¦œ (1å¤©): {len(new)} æª”")
    
    # 2. ç”¢æ¥­åˆ†æ
    print("\n[2/3] ç”¢æ¥­è¼ªå‹•åˆ†æ...")
    industry_stats = get_industry_analysis()
    for stat in industry_stats[:3]:
        print(f"  {stat['industry']}: {stat['count']} æª”éç†±")
    
    # 3. æ•´é«”çµ±è¨ˆ
    print("\n[3/3] æ•´é«”çµ±è¨ˆ...")
    stats = get_statistics()
    print(f"  éç†±: {stats['overheat']} æª”")
    print(f"  è­¦æˆ’: {stats['warning']} æª”")
    print(f"  æ´»èº: {stats['active']} æª”")
    print(f"  æ­£å¸¸: {stats['normal']} æª”")
    
    # è¼¸å‡º JSON
    # å–å¾—æ‰€æœ‰è‚¡ç¥¨åˆ†é¡
    all_classified = get_all_stocks_classified()
    
    output = {
        'updated_at': datetime.now().isoformat(),
        'statistics': stats,
        'overheat_stocks': {
            'extreme_danger': extreme_danger,
            'severe': severe,
            'overheat': overheat,
            'warning': warning,
            'new': new
        },
        'industry_stats': industry_stats,
        'all_stocks': all_classified['all'],
        'active_stocks': all_classified['active'],
        'normal_stocks': all_classified['normal']
    }
        'industry_stats': industry_stats
    }
    
    # å„²å­˜ JSON
    with open('data/turnover_analysis.json', 'w', encoding='utf-8') as f:
        json.dump(output, f, ensure_ascii=False, indent=2)
    
    print("\n" + "="*60)
    print("âœ“ åˆ†æå®Œæˆ! å·²è¼¸å‡º: data/turnover_analysis.json")
    print("="*60)
    
    return output

if __name__ == '__main__':
    analyze_and_export()
